# ✅ End-to-End Tests – سیستم تیکتینگ ایرانمهر

## فهرست مطالب
1. [معرفی](#معرفی)
2. [سناریوهای خودکار](#سناریوهای-خودکار)
3. [سناریوهای ربات تلگرام](#سناریوهای-ربات-تلگرام)
4. [سناریوهای وب‌اپلیکیشن](#سناریوهای-وب‌اپلیکیشن)
5. [اجرای تست‌ها](#اجرای-تستها)
6. [نتایج و گزارش](#نتایج-و-گزارش)
7. [گام‌های بعدی پیشنهاد شده](#گامهای-بعدی)

---

## معرفی

End-to-End Tests برای اطمینان از صحت جریان کامل سیستم (از ورود کاربر تا بستن تیکت) و همچنین تعامل ربات تلگرام با API طراحی شده‌اند. این تست‌ها بر پایه `pytest` اجرا شده و سناریوهای واقعی پورتال کاربری و ربات تلگرام را پوشش می‌دهند.

---

## سناریوهای خودکار

### 1. `test_full_ticket_lifecycle_flow`
- ایجاد شعبه و دپارتمان
- ایجاد کاربر عادی و ادمین
- ورود کاربر و ثبت تیکت
- مشاهده لیست تیکت‌ها (مانند داشبورد پنل)
- تخصیص تیکت توسط ادمین، شروع و توقف تایمر
- اضافه کردن کامنت و حل تیکت
- بررسی تاریخچه و تایم‌لاگ‌ها

### 2. `test_telegram_api_client_can_login_and_create_ticket`
- ورود از طریق APIClient ربات تلگرام
- دریافت لیست شعب
- ثبت تیکت جدید از طریق ربات
- بررسی لیست تیکت‌های کاربر

---

## سناریوهای ربات تلگرام

### تست‌های خودکار
- APIClient واقعی به اپلیکیشن FastAPI متصل و عملیات ورود، دریافت شعب و ثبت تیکت را انجام می‌دهد.
- این تست تضمین می‌کند که ربات می‌تواند بدون وابستگی خارجی با API تعامل کند.

### چک‌لیست دستی (پیشنهادی)
1. اجرای ربات با `python app/telegram_bot/run.py`
2. دستور `/start` و ورود از طریق ربات
3. ثبت تیکت جدید با دسته‌بندی و شعبه
4. استفاده از `/mytickets` برای مشاهده وضعیت
5. دریافت اعلان‌های تغییر وضعیت در تلگرام

---

## سناریوهای وب‌اپلیکیشن

### پوشش داده‌شده توسط تست خودکار
- ثبت تیکت (همان درخواست استفاده‌شده در پورتال)
- استفاده از فیلترها (وضعیت، اولویت)
- تایم‌لاگ و تاریخچه (برای گزارش‌دهی)

### چک‌لیست دستی (پیشنهادی)
1. ورود ادمین به `web_admin`
2. ثبت تیکت از User Portal
3. مشاهده جزئیات تیکت از پنل ادمین
4. بررسی Time Tracker و Custom Fields
5. خروجی PDF/Excel در داشبورد

---

## اجرای تست‌ها

```bash
# اجرای تمام تست‌های E2E
pytest tests/test_e2e.py -m e2e -v

# یا همراه سایر تست‌ها
pytest -m \"e2e\"
```

> نکته: تست‌های تلگرام از `httpx.AsyncClient` به‌صورت in-memory استفاده می‌کنند و نیازی به توکن واقعی نیست.

---

## نتایج و گزارش

- همه سناریوهای E2E با موفقیت اجرا می‌شوند.
- پوشش‌دهی:
  - Portal Flow
  - Time Tracker
  - Ticket History
  - Comments
  - Telegram Bot API Client

---

## گام‌های بعدی

1. اضافه‌کردن سناریوهای Playwright برای UI (در صورت نیاز)
2. خودکارسازی تست‌های دستی (e.g. ثبت از User Portal واقعی)
3. اتصال تست‌های E2E به CI/CD
4. افزایش پوشش برای Telegram (مثلاً شبیه‌سازی مکالمه کامل)

---

**آخرین به‌روزرسانی:** 2025-01-23  
**نگهدارنده:** تیم توسعه سیستم تیکتینگ ایرانمهر

