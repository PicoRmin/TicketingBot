# ุฑุงูููุง ูุงุฒ ด: API Core - ูุฏุฑุช ุชฺฉุชโูุง / Phase 4: Ticket Management API Guide

## โ ฺฉุงุฑูุง ุงูุฌุงู ุดุฏู

### ฑ. ุงุฌุงุฏ Ticket Schemas
- โ `TicketBase` - Base schema ุจุฑุง Ticket
- โ `TicketCreate` - Schema ุจุฑุง ุงุฌุงุฏ ุชฺฉุช
- โ `TicketUpdate` - Schema ุจุฑุง ุจูโุฑูุฒุฑุณุงู ุชฺฉุช
- โ `TicketStatusUpdate` - Schema ุจุฑุง ุชุบุฑ ูุถุนุช
- โ `TicketResponse` - Schema ุจุฑุง ูพุงุณุฎ API
- โ `TicketListResponse` - Schema ุจุฑุง ูุณุช ุจุง pagination

### ฒ. ุงุฌุงุฏ Ticket Service
- โ `generate_ticket_number` - ุชููุฏ ุดูุงุฑู ุชฺฉุช ฺฉุชุง (T-YYYYMMDD-####)
- โ `create_ticket` - ุงุฌุงุฏ ุชฺฉุช ุฌุฏุฏ
- โ `get_ticket` - ุฏุฑุงูุช ุชฺฉุช ุจุฑ ุงุณุงุณ ID
- โ `get_ticket_by_number` - ุฏุฑุงูุช ุชฺฉุช ุจุฑ ุงุณุงุณ ุดูุงุฑู
- โ `update_ticket` - ุจูโุฑูุฒุฑุณุงู ุชฺฉุช
- โ `update_ticket_status` - ุชุบุฑ ูุถุนุช ุชฺฉุช
- โ `get_user_tickets` - ุฏุฑุงูุช ุชฺฉุชโูุง ฺฉุงุฑุจุฑ ุจุง ููุชุฑ
- โ `get_all_tickets` - ุฏุฑุงูุช ููู ุชฺฉุชโูุง (ุจุฑุง ุงุฏูู) ุจุง ููุชุฑ
- โ `delete_ticket` - ุญุฐู ุชฺฉุช
- โ `can_user_access_ticket` - ุจุฑุฑุณ ุฏุณุชุฑุณ ฺฉุงุฑุจุฑ ุจู ุชฺฉุช

### ณ. ุงุฌุงุฏ Ticket API Endpoints
- โ `POST /api/tickets` - ุงุฌุงุฏ ุชฺฉุช ุฌุฏุฏ
- โ `GET /api/tickets` - ูุณุช ุชฺฉุชโูุง (ุจุง pagination ู ููุชุฑ)
- โ `GET /api/tickets/{ticket_id}` - ุฌุฒุฆุงุช ุชฺฉุช ุจุฑ ุงุณุงุณ ID
- โ `GET /api/tickets/number/{ticket_number}` - ุฌุฒุฆุงุช ุชฺฉุช ุจุฑ ุงุณุงุณ ุดูุงุฑู
- โ `PUT /api/tickets/{ticket_id}` - ุจูโุฑูุฒุฑุณุงู ุชฺฉุช
- โ `PATCH /api/tickets/{ticket_id}/status` - ุชุบุฑ ูุถุนุช ุชฺฉุช (ููุท ุงุฏูู)
- โ `DELETE /api/tickets/{ticket_id}` - ุญุฐู ุชฺฉุช (ููุท ุงุฏูู)

### ด. ูฺฺฏโูุง ูพุงุฏูโุณุงุฒ ุดุฏู
- โ ุชููุฏ ุดูุงุฑู ุชฺฉุช ฺฉุชุง (T-YYYYMMDD-####)
- โ Pagination ุจุฑุง ูุณุช ุชฺฉุชโูุง
- โ ููุชุฑ ุจุฑ ุงุณุงุณ ูุถุนุช (status)
- โ ููุชุฑ ุจุฑ ุงุณุงุณ ุฏุณุชูโุจูุฏ (category)
- โ ูุฏุฑุช ุฏุณุชุฑุณ (ฺฉุงุฑุจุฑุงู ููุท ุชฺฉุชโูุง ุฎูุฏุ ุงุฏูู ููู)
- โ ุงุนุชุจุงุฑุณูุฌ ุฏุงุฏูโูุง ุจุง Pydantic

## ๐ ุชุณุช API

### ุชุณุช ุจุง Swagger UI

1. **ุงุฌุฑุง Application**:
   ```bash
   uvicorn app.main:app --reload
   ```

2. **ุจุงุฒ ฺฉุฑุฏู Swagger UI**:
   - ุขุฏุฑุณ: http://localhost:8000/docs

3. **ุชุณุช ุงุฌุงุฏ ุชฺฉุช**:
   - ุงุจุชุฏุง Login ฺฉูุฏ ู Token ุฏุฑุงูุช ฺฉูุฏ
   - ฺฉูฺฉ ุฑู "Authorize" ู Token ุฑุง ูุงุฑุฏ ฺฉูุฏ
   - ฺฉูฺฉ ุฑู `POST /api/tickets`
   - ูุงุฑุฏ ฺฉุฑุฏู ุฏุงุฏูโูุง:
     ```json
     {
       "title": "ูุดฺฉู ุงูุชุฑูุช",
       "description": "ุงูุชุฑูุช ูุทุน ุดุฏู ุงุณุช",
       "category": "internet"
     }
     ```
   - ฺฉูฺฉ ุฑู "Execute"
   - ูุดุงูุฏู ุชฺฉุช ุงุฌุงุฏ ุดุฏู ุจุง ุดูุงุฑู ฺฉุชุง

4. **ุชุณุช ูุณุช ุชฺฉุชโูุง**:
   - ฺฉูฺฉ ุฑู `GET /api/tickets`
   - ูโุชูุงูุฏ ููุชุฑูุง ุฑุง ุชูุธู ฺฉูุฏ:
     - `page`: ุดูุงุฑู ุตูุญู
     - `page_size`: ุชุนุฏุงุฏ ุขุชู ุฏุฑ ูุฑ ุตูุญู
     - `status`: ููุชุฑ ุจุฑ ุงุณุงุณ ูุถุนุช
     - `category`: ููุชุฑ ุจุฑ ุงุณุงุณ ุฏุณุชูโุจูุฏ
   - ฺฉูฺฉ ุฑู "Execute"
   - ูุดุงูุฏู ูุณุช ุชฺฉุชโูุง ุจุง pagination

5. **ุชุณุช ุชุบุฑ ูุถุนุช** (ููุท ุงุฏูู):
   - ฺฉูฺฉ ุฑู `PATCH /api/tickets/{ticket_id}/status`
   - ูุงุฑุฏ ฺฉุฑุฏู `ticket_id`
   - ูุงุฑุฏ ฺฉุฑุฏู `status` ุฌุฏุฏ
   - ฺฉูฺฉ ุฑู "Execute"

### ุชุณุช ุจุง curl

```bash
# 1. Login ู ุฏุฑุงูุช Token
TOKEN=$(curl -X POST "http://localhost:8000/api/auth/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin&password=admin123" | jq -r '.access_token')

# 2. ุงุฌุงุฏ ุชฺฉุช
curl -X POST "http://localhost:8000/api/tickets" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "ูุดฺฉู ุงูุชุฑูุช",
    "description": "ุงูุชุฑูุช ูุทุน ุดุฏู ุงุณุช",
    "category": "internet"
  }'

# 3. ุฏุฑุงูุช ูุณุช ุชฺฉุชโูุง
curl -X GET "http://localhost:8000/api/tickets?page=1&page_size=10" \
  -H "Authorization: Bearer $TOKEN"

# 4. ุฏุฑุงูุช ุชฺฉุช ุจุฑ ุงุณุงุณ ID
curl -X GET "http://localhost:8000/api/tickets/1" \
  -H "Authorization: Bearer $TOKEN"

# 5. ุชุบุฑ ูุถุนุช ุชฺฉุช (ููุท ุงุฏูู)
curl -X PATCH "http://localhost:8000/api/tickets/1/status" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"status": "in_progress"}'
```

## ๐ ุณุงุฎุชุงุฑ ูุงูโูุง ุงุฌุงุฏ ุดุฏู

```
app/
โโโ api/
โ   โโโ tickets.py          โ Ticket endpoints
โโโ schemas/
โ   โโโ ticket.py           โ Ticket schemas
โโโ services/
    โโโ ticket_service.py   โ Ticket business logic
```

## ๐ API Endpoints

### POST /api/tickets
- **Description**: ุงุฌุงุฏ ุชฺฉุช ุฌุฏุฏ
- **Authentication**: Required
- **Request Body**: `TicketCreate`
- **Response**: `TicketResponse` (201 Created)
- **Access**: ููู ฺฉุงุฑุจุฑุงู

### GET /api/tickets
- **Description**: ูุณุช ุชฺฉุชโูุง ุจุง pagination ู ููุชุฑ
- **Authentication**: Required
- **Query Parameters**:
  - `page`: ุดูุงุฑู ุตูุญู (default: 1)
  - `page_size`: ุชุนุฏุงุฏ ุขุชู ุฏุฑ ูุฑ ุตูุญู (default: 10, max: 100)
  - `status`: ููุชุฑ ุจุฑ ุงุณุงุณ ูุถุนุช (optional)
  - `category`: ููุชุฑ ุจุฑ ุงุณุงุณ ุฏุณุชูโุจูุฏ (optional)
- **Response**: `TicketListResponse`
- **Access**: 
  - ฺฉุงุฑุจุฑุงู: ููุท ุชฺฉุชโูุง ุฎูุฏ
  - ุงุฏูู: ููู ุชฺฉุชโูุง

### GET /api/tickets/{ticket_id}
- **Description**: ุฏุฑุงูุช ุชฺฉุช ุจุฑ ุงุณุงุณ ID
- **Authentication**: Required
- **Response**: `TicketResponse`
- **Access**: 
  - ฺฉุงุฑุจุฑุงู: ููุท ุชฺฉุชโูุง ุฎูุฏ
  - ุงุฏูู: ููู ุชฺฉุชโูุง

### GET /api/tickets/number/{ticket_number}
- **Description**: ุฏุฑุงูุช ุชฺฉุช ุจุฑ ุงุณุงุณ ุดูุงุฑู ุชฺฉุช
- **Authentication**: Required
- **Response**: `TicketResponse`
- **Access**: 
  - ฺฉุงุฑุจุฑุงู: ููุท ุชฺฉุชโูุง ุฎูุฏ
  - ุงุฏูู: ููู ุชฺฉุชโูุง

### PUT /api/tickets/{ticket_id}
- **Description**: ุจูโุฑูุฒุฑุณุงู ุชฺฉุช
- **Authentication**: Required
- **Request Body**: `TicketUpdate`
- **Response**: `TicketResponse`
- **Access**: 
  - ฺฉุงุฑุจุฑุงู: ููุท ุชฺฉุชโูุง ุฎูุฏ (ููโุชูุงููุฏ status ุฑุง ุชุบุฑ ุฏููุฏ)
  - ุงุฏูู: ููู ุชฺฉุชโูุง

### PATCH /api/tickets/{ticket_id}/status
- **Description**: ุชุบุฑ ูุถุนุช ุชฺฉุช
- **Authentication**: Required (Admin only)
- **Request Body**: `TicketStatusUpdate`
- **Response**: `TicketResponse`
- **Access**: ููุท ุงุฏูู

### DELETE /api/tickets/{ticket_id}
- **Description**: ุญุฐู ุชฺฉุช
- **Authentication**: Required (Admin only)
- **Response**: 204 No Content
- **Access**: ููุท ุงุฏูู

## ๐ ูุฏุฑุช ุฏุณุชุฑุณ

### ููุงูู ุฏุณุชุฑุณ

1. **ฺฉุงุฑุจุฑุงู ุนุงุฏ (USER)**:
   - ูโุชูุงููุฏ ุชฺฉุช ุงุฌุงุฏ ฺฉููุฏ
   - ููุท ุชฺฉุชโูุง ุฎูุฏ ุฑุง ูโุจููุฏ
   - ูโุชูุงููุฏ ุชฺฉุชโูุง ุฎูุฏ ุฑุง ุจูโุฑูุฒุฑุณุงู ฺฉููุฏ (ุจู ุฌุฒ status)
   - ููโุชูุงููุฏ ูุถุนุช ุชฺฉุช ุฑุง ุชุบุฑ ุฏููุฏ
   - ููโุชูุงููุฏ ุชฺฉุช ุฑุง ุญุฐู ฺฉููุฏ

2. **ุงุฏูู (ADMIN)**:
   - ูโุชูุงููุฏ ุชฺฉุช ุงุฌุงุฏ ฺฉููุฏ
   - ููู ุชฺฉุชโูุง ุฑุง ูโุจููุฏ
   - ูโุชูุงููุฏ ููู ุชฺฉุชโูุง ุฑุง ุจูโุฑูุฒุฑุณุงู ฺฉููุฏ
   - ูโุชูุงููุฏ ูุถุนุช ูุฑ ุชฺฉุช ุฑุง ุชุบุฑ ุฏููุฏ
   - ูโุชูุงููุฏ ุชฺฉุชโูุง ุฑุง ุญุฐู ฺฉููุฏ

## ๐ ุดูุงุฑู ุชฺฉุช

### ูุฑูุช ุดูุงุฑู ุชฺฉุช
- **ูุฑูุช**: `T-YYYYMMDD-####`
- **ูุซุงู**: `T-20241111-0001`
- **ุชูุถุญุงุช**:
  - `T-`: ูพุดููุฏ ุซุงุจุช
  - `YYYYMMDD`: ุชุงุฑุฎ ุงุฌุงุฏ (ุณุงู-ูุงู-ุฑูุฒ)
  - `####`: ุดูุงุฑู ุชูุงู ด ุฑูู (ุงุฒ 0001 ุดุฑูุน ูโุดูุฏ)

### ูฺฺฏโูุง
- โ ฺฉุชุง ุจูุฏู ุฏุฑ ูุฑ ุฑูุฒ
- โ ุดูุงุฑูโฺฏุฐุงุฑ ุฎูุฏฺฉุงุฑ
- โ ูุงุจู ุฌุณุชุฌู ู ููุชุฑ

## โ ฺฺฉโูุณุช

- [x] Schemas ุงุฌุงุฏ ุดุฏู
- [x] Service ุงุฌุงุฏ ุดุฏู
- [x] API Endpoints ุงุฌุงุฏ ุดุฏู
- [x] Pagination ูพุงุฏูโุณุงุฒ ุดุฏู
- [x] ููุชุฑ ู ุฌุณุชุฌู ูพุงุฏูโุณุงุฒ ุดุฏู
- [x] ูุฏุฑุช ุฏุณุชุฑุณ ูพุงุฏูโุณุงุฒ ุดุฏู
- [x] ุชููุฏ ุดูุงุฑู ุชฺฉุช ฺฉุชุง
- [x] ุชุณุช Service
- [x] Router ุงุถุงูู ุดุฏู ุจู main.py

## ๐ ุนุจโุงุจ

### ูุดฺฉู: 403 Forbidden
**ุฑุงูโุญู**: ูุทูุฆู ุดูุฏ ฺฉู:
- ฺฉุงุฑุจุฑ ุณุน ูโฺฉูุฏ ุจู ุชฺฉุช ุฎูุฏ ุฏุณุชุฑุณ ุฏุงุดุชู ุจุงุดุฏ
- ุง ฺฉุงุฑุจุฑ ุงุฏูู ุงุณุช

### ูุดฺฉู: 404 Not Found
**ุฑุงูโุญู**: ูุทูุฆู ุดูุฏ ฺฉู:
- ticket_id ุตุญุญ ุงุณุช
- ุชฺฉุช ูุฌูุฏ ุฏุงุฑุฏ

### ูุดฺฉู: ุดูุงุฑู ุชฺฉุช ุชฺฉุฑุงุฑ
**ุฑุงูโุญู**: ุงู ูุดฺฉู ูุจุงุฏ ุฑุฎ ุฏูุฏ ฺูู ุดูุงุฑู ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุชููุฏ ูโุดูุฏ. ุงฺฏุฑ ุฑุฎ ุฏุงุฏุ ุฏุชุงุจุณ ุฑุง ุจุฑุฑุณ ฺฉูุฏ.

## ๐ฏ ูุฑุงุญู ุจุนุฏ

ูพุณ ุงุฒ ุชฺฉูู ูุงุฒ ดุ ูโุชูุงูุฏ ุจู ูุงุฒ ต ุจุฑูุฏ:
- **ูุงุฒ ต**: ุณุณุชู ูุงู (File Management)

---

**ุชุงุฑุฎ ุชฺฉูู**: 2024-11-11

